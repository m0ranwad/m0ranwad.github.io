---
import BaseLayout from '../layouts/BaseLayout.astro';
import PageHeader from '../components/ui/PageHeader.astro';
import CTASection from '../components/ui/CTASection.astro';
import { formConfig } from '../config/forms';
import { getFeaturedMenu } from '../data/menus';

const featuredMenu = getFeaturedMenu();
const featuredSlug = '/' + featuredMenu.slug + '/';
const redirectUrl = (Astro.site || 'https://thymelesstreatsbakery.com') + formConfig.thankYouPage;
---

<BaseLayout 
  title="Place Your Order" 
  description="Order custom cookies, cakes, and seasonal treats from Thymeless Treats Bakery. Fill out our form to get started!"
>
  <PageHeader 
    title="Your Order"
    subtitle="Review your selections and submit your inquiry"
  />

  <div class="order-container">
    <!-- Cart Section -->
    <section class="cart-section">
      <h2>Your Selections</h2>
      <div class="empty-cart" id="empty-cart">
        <h3>No items selected yet</h3>
        <p>Browse our menus and add items you'd like to inquire about!</p>
        <a href={featuredSlug} class="browse-btn">Browse {featuredMenu.title}</a>
      </div>
      <div class="cart-items" id="cart-items"></div>
      <div class="cart-actions" id="cart-actions">
        <button type="button" class="clear-cart-btn" id="clear-cart-btn">Clear all</button>
        <a href={featuredSlug} class="add-more-link">+ Add more items</a>
      </div>
    </section>

    <!-- Order Form Section -->
    <section class="order-form-section" id="order-form">
      <h2>Complete Your Inquiry</h2>
      <p class="intro">Fill out the details below and I'll get back to you within 24 hours!</p>
      
      <form action="https://api.web3forms.com/submit" method="POST" class="inquiry-form" id="inquiry-form">
        <input type="hidden" name="access_key" value={formConfig.web3formsAccessKey} />
        <input type="hidden" name="subject" value="New Order Inquiry - Thymeless Treats" />
        <input type="hidden" name="from_name" value="Thymeless Treats Website" />
        <input type="hidden" name="redirect" value={redirectUrl} />
        <input type="hidden" name="items_summary" id="items-summary" value="" />
        <input type="checkbox" name="botcheck" style="display:none" />
        
        <div class="form-grid">
          <div class="form-group">
            <label for="name">Your Name *</label>
            <input type="text" id="name" name="name" required />
          </div>
          <div class="form-group">
            <label for="email">Email Address *</label>
            <input type="email" id="email" name="email" required />
          </div>
          <div class="form-group">
            <label for="phone">Phone Number</label>
            <input type="tel" id="phone" name="phone" />
          </div>
          <div class="form-group">
            <label for="event_date">Event/Pickup Date *</label>
            <input type="date" id="event_date" name="event_date" required />
          </div>
          <div class="form-group full-width">
            <label for="message">Additional Details</label>
            <textarea id="message" name="message" rows="4" placeholder="Tell me about your event, special requests, or dietary restrictions!"></textarea>
          </div>
        </div>
        
        <div class="form-submit">
          <button type="submit" class="submit-btn">Submit Inquiry</button>
          <p class="submit-note">I'll respond within 24 hours with pricing and availability.</p>
        </div>
      </form>
    </section>

    <!-- What to Expect -->
    <section class="what-to-expect">
      <h2>How It Works</h2>
      <div class="steps-grid">
        <div class="step">
          <div class="step-number">1</div>
          <h3>Browse & Select</h3>
          <p>Browse our menus and click "Add to Inquiry" on items you like.</p>
        </div>
        <div class="step">
          <div class="step-number">2</div>
          <h3>Submit Your Inquiry</h3>
          <p>Fill out the form above with your details and event date.</p>
        </div>
        <div class="step">
          <div class="step-number">3</div>
          <h3>Get Your Quote</h3>
          <p>I'll review your request and send you pricing within 24 hours.</p>
        </div>
        <div class="step">
          <div class="step-number">4</div>
          <h3>Confirm & Enjoy!</h3>
          <p>Approve, pay deposit, and pick up your fresh-baked treats!</p>
        </div>
      </div>
    </section>
  </div>

  <CTASection 
    title="Questions?"
    subtitle="Not sure what to order? Have dietary restrictions? Just want to chat? I'd love to hear from you!"
    primaryText="Contact Me"
    primaryHref="/contact/"
    variant="cream"
  />
</BaseLayout>

<script>
  import { getItems, removeItem, updateQuantity, clear, getCartSummary } from '../scripts/inquiry-store';
  
  function renderCart() {
    const items = getItems();
    const emptyCart = document.getElementById('empty-cart');
    const cartItems = document.getElementById('cart-items');
    const cartActions = document.getElementById('cart-actions');
    const itemsSummary = document.getElementById('items-summary') as HTMLInputElement;
    
    if (items.length === 0) {
      if (emptyCart) emptyCart.style.display = 'flex';
      if (cartItems) cartItems.style.display = 'none';
      if (cartActions) cartActions.style.display = 'none';
      if (itemsSummary) itemsSummary.value = '';
      return;
    }
    
    if (emptyCart) emptyCart.style.display = 'none';
    if (cartItems) cartItems.style.display = 'flex';
    if (cartActions) cartActions.style.display = 'flex';
    if (itemsSummary) itemsSummary.value = getCartSummary();
    
    if (cartItems) {
      let html = '';
      for (const item of items) {
        const img = item.image ? '<img src="' + item.image + '" alt="' + item.name + '" class="cart-item-image" />' : '';
        html += '<div class="cart-item" data-id="' + item.id + '">' +
          img +
          '<div class="cart-item-details">' +
            '<h4>' + item.name + '</h4>' +
            '<p class="cart-item-menu">' + item.menu + '</p>' +
            '<p class="cart-item-price">' + item.price + '</p>' +
          '</div>' +
          '<div class="cart-item-quantity">' +
            '<button type="button" class="qty-btn minus" data-id="' + item.id + '" aria-label="Decrease quantity">−</button>' +
            '<span class="qty-value">' + item.quantity + '</span>' +
            '<button type="button" class="qty-btn plus" data-id="' + item.id + '" aria-label="Increase quantity">+</button>' +
          '</div>' +
          '<button type="button" class="remove-btn" data-id="' + item.id + '" aria-label="Remove item">×</button>' +
        '</div>';
      }
      cartItems.innerHTML = html;
    }
  }

  function setupEventListeners() {
    const cartItems = document.getElementById('cart-items');
    if (cartItems) {
      cartItems.addEventListener('click', (e) => {
        const target = e.target as HTMLElement;
        const button = target.closest('.qty-btn, .remove-btn') as HTMLElement;
        if (!button) return;
        
        const id = button.dataset.id;
        if (!id) return;
        
        if (button.classList.contains('minus')) {
          const item = getItems().find(i => i.id === id);
          if (item && item.quantity > 1) {
            updateQuantity(id, item.quantity - 1);
          } else {
            removeItem(id);
          }
          renderCart();
        } else if (button.classList.contains('plus')) {
          const item = getItems().find(i => i.id === id);
          if (item) {
            updateQuantity(id, item.quantity + 1);
            renderCart();
          }
        } else if (button.classList.contains('remove-btn')) {
          removeItem(id);
          renderCart();
        }
      });
    }
    
    const clearBtn = document.getElementById('clear-cart-btn');
    if (clearBtn) {
      clearBtn.addEventListener('click', () => {
        if (confirm('Remove all items?')) {
          clear();
          renderCart();
        }
      });
    }
  }

  function setMinDate() {
    const dateInput = document.getElementById('event_date') as HTMLInputElement;
    if (dateInput) {
      const minDate = new Date();
      minDate.setDate(minDate.getDate() + 5);
      dateInput.min = minDate.toISOString().split('T')[0];
    }
  }
  
  document.addEventListener('DOMContentLoaded', () => {
    renderCart();
    setupEventListeners();
    setMinDate();
  });
</script>

<style>
  .order-container {
    max-width: 900px;
    margin: 0 auto;
    padding: 0 var(--space-lg) var(--space-3xl);
  }

  section {
    margin-bottom: var(--space-3xl);
  }

  section h2 {
    font-family: var(--font-heading);
    font-size: clamp(1.75rem, 4vw, 2.25rem);
    color: var(--charcoal);
    text-align: center;
    margin-bottom: var(--space-lg);
  }

  .intro {
    text-align: center;
    color: var(--warm-gray);
    max-width: 550px;
    margin: 0 auto var(--space-xl);
  }

  /* Empty Cart */
  .empty-cart {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    padding: var(--space-3xl) var(--space-xl);
    background: var(--cream);
    border-radius: 16px;
    border: 2px dashed var(--sage-light);
  }

  .empty-cart h3 {
    font-family: var(--font-heading);
    font-size: 1.5rem;
    color: var(--charcoal);
    margin: 0 0 var(--space-sm) 0;
  }

  .empty-cart p {
    color: var(--warm-gray);
    margin: 0 0 var(--space-xl) 0;
  }

  .browse-btn {
    display: inline-block;
    padding: var(--space-md) var(--space-xl);
    background: linear-gradient(135deg, var(--sage) 0%, var(--sage-dark) 100%);
    color: var(--white);
    text-decoration: none;
    border-radius: 8px;
    font-weight: 500;
    min-height: 44px;
  }

  /* Cart Items */
  .cart-items {
    display: none;
    flex-direction: column;
    gap: var(--space-md);
  }

  .cart-item {
    display: grid;
    grid-template-columns: 48px 1fr auto auto;
    gap: var(--space-md);
    align-items: center;
    padding: var(--space-md) var(--space-lg);
    background: var(--white);
    border-radius: 12px;
    border: 1px solid var(--sage-light);
  }

  .cart-item-image {
    width: 48px;
    height: 48px;
    object-fit: cover;
    border-radius: 8px;
  }

  .cart-item-details h4 {
    margin: 0 0 4px 0;
    font-family: var(--font-heading);
    font-size: 1.0625rem;
    color: var(--charcoal);
  }

  .cart-item-menu {
    font-size: 0.8125rem;
    color: var(--warm-gray);
    margin: 0;
  }

  .cart-item-price {
    font-family: var(--font-accent);
    font-size: 0.9375rem;
    color: var(--sage-dark);
    margin: 4px 0 0 0;
  }

  /* Elegant quantity stepper */
  .cart-item-quantity {
    display: flex;
    align-items: center;
    gap: 0;
    border: 1px solid var(--sage-light);
    border-radius: 8px;
    overflow: hidden;
    background: var(--cream);
  }

  .qty-btn {
    width: 36px;
    height: 36px;
    border: none;
    background: transparent;
    cursor: pointer;
    font-size: 1.125rem;
    color: var(--sage-dark);
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background-color 0.15s ease, color 0.15s ease;
  }

  .qty-btn:hover {
    background: var(--sage-light);
  }

  .qty-btn:active {
    background: var(--sage);
    color: white;
  }

  .qty-value {
    min-width: 32px;
    text-align: center;
    font-weight: 600;
    font-size: 0.9375rem;
    color: var(--charcoal);
    background: var(--white);
    padding: 0 4px;
    height: 36px;
    line-height: 36px;
    border-left: 1px solid var(--sage-light);
    border-right: 1px solid var(--sage-light);
  }

  /* Elegant remove button */
  .remove-btn {
    width: 36px;
    height: 36px;
    border: 1px solid transparent;
    background: transparent;
    color: var(--warm-gray);
    cursor: pointer;
    font-size: 1.25rem;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.15s ease;
  }

  .remove-btn:hover {
    border-color: var(--sage-light);
    background: var(--cream);
    color: var(--charcoal);
  }

  .cart-actions {
    display: none;
    justify-content: space-between;
    align-items: center;
    margin-top: var(--space-lg);
    padding-top: var(--space-lg);
    border-top: 1px solid var(--sage-light);
  }

  .clear-cart-btn {
    padding: var(--space-sm) var(--space-md);
    background: transparent;
    border: 1px solid var(--sage-light);
    border-radius: 8px;
    color: var(--warm-gray);
    cursor: pointer;
    font-size: 0.875rem;
    transition: all 0.15s ease;
  }

  .clear-cart-btn:hover {
    border-color: var(--warm-gray);
    color: var(--charcoal);
  }

  .add-more-link {
    color: var(--sage-dark);
    font-weight: 500;
    text-decoration: none;
    font-size: 0.9375rem;
    transition: color 0.15s ease;
  }

  .add-more-link:hover {
    color: var(--sage);
    text-decoration: underline;
    text-underline-offset: 2px;
  }

  /* Form Styles */
  .inquiry-form {
    background: var(--white);
    padding: var(--space-2xl);
    border-radius: 16px;
    box-shadow: var(--shadow-soft);
  }

  .form-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--space-lg);
  }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: var(--space-xs);
  }

  .form-group.full-width {
    grid-column: 1 / -1;
  }

  .form-group label {
    font-weight: 500;
    color: var(--charcoal);
  }

  .form-group input,
  .form-group textarea {
    padding: var(--space-md);
    border: 1px solid var(--sage-light);
    border-radius: 8px;
    font-size: 1rem;
    min-height: 44px;
  }

  .form-group input:focus,
  .form-group textarea:focus {
    outline: none;
    border-color: var(--sage);
  }

  .form-group textarea {
    resize: vertical;
    min-height: 100px;
  }

  .form-submit {
    margin-top: var(--space-xl);
    text-align: center;
  }

  .submit-btn {
    padding: var(--space-md) var(--space-2xl);
    background: linear-gradient(135deg, var(--sage) 0%, var(--sage-dark) 100%);
    color: var(--white);
    border: none;
    border-radius: 8px;
    font-size: 1.0625rem;
    font-weight: 600;
    cursor: pointer;
    min-height: 48px;
  }

  .submit-note {
    margin-top: var(--space-md);
    font-size: 0.875rem;
    color: var(--warm-gray);
  }

  /* Steps Grid */
  .steps-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: var(--space-xl);
  }

  .step {
    text-align: center;
    padding: var(--space-md);
  }

  .step-number {
    width: 44px;
    height: 44px;
    background: var(--sage);
    color: var(--white);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: var(--font-heading);
    font-size: 1.25rem;
    font-weight: 700;
    margin: 0 auto var(--space-md);
  }

  .step h3 {
    font-family: var(--font-heading);
    font-size: 1.125rem;
    color: var(--charcoal);
    margin-bottom: var(--space-xs);
  }

  .step p {
    color: var(--warm-gray);
    font-size: 0.875rem;
  }

  .what-to-expect {
    background: var(--cream);
    margin-left: calc(-1 * var(--space-lg));
    margin-right: calc(-1 * var(--space-lg));
    padding: var(--space-3xl) var(--space-lg);
  }

  @media (max-width: 600px) {
    .form-grid {
      grid-template-columns: 1fr;
    }

    .inquiry-form {
      padding: var(--space-lg);
    }

    .cart-item {
      grid-template-columns: 40px 1fr auto;
      gap: var(--space-sm);
    }

    .cart-item-image {
      width: 40px;
      height: 40px;
    }

    .cart-item-quantity {
      grid-column: 2 / -1;
      justify-self: start;
      margin-top: var(--space-xs);
    }

    .remove-btn {
      grid-row: 1;
      grid-column: 3;
    }

    .qty-btn {
      width: 32px;
      height: 32px;
    }

    .qty-value {
      min-width: 28px;
      height: 32px;
      line-height: 32px;
      font-size: 0.875rem;
    }
  }

  @media (min-width: 932px) {
    .what-to-expect {
      margin-left: calc(-50vw + 450px - var(--space-lg));
      margin-right: calc(-50vw + 450px - var(--space-lg));
      padding-left: calc(50vw - 450px + var(--space-lg));
      padding-right: calc(50vw - 450px + var(--space-lg));
    }
  }
</style>
