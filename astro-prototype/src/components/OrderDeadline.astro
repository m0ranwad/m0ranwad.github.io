---
/**
 * Order Deadline Countdown
 * 
 * Shows a countdown to the order cutoff date for seasonal menus.
 * - Displays "X days left to order" message
 * - Shows urgency colors when deadline approaches
 * - Disappears after deadline passes
 * 
 * Usage:
 *   <OrderDeadline deadline="2025-02-10" label="Valentine's orders" />
 */

interface Props {
  /** Deadline date in ISO format (YYYY-MM-DD) */
  deadline: string;
  /** Label text (e.g., "Valentine's orders") */
  label?: string;
  /** Where to link when clicked */
  href?: string;
}

const { 
  deadline,
  label = "Orders",
  href = "/order/"
} = Astro.props;

// Calculate initial days remaining (for SSG)
const deadlineDate = new Date(deadline + 'T23:59:59');
const now = new Date();
const diffTime = deadlineDate.getTime() - now.getTime();
const initialDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

// Determine urgency level for initial render
const getUrgencyClass = (days: number) => {
  if (days <= 0) return 'expired';
  if (days <= 2) return 'urgent';
  if (days <= 5) return 'soon';
  return 'normal';
};

const urgencyClass = getUrgencyClass(initialDays);
---

{initialDays > 0 && (
  <a 
    href={href}
    class={`order-deadline ${urgencyClass}`}
    data-deadline={deadline}
    id="order-deadline"
  >
    <span class="deadline-icon">⏰</span>
    <span class="deadline-text">
      <strong>{label}</strong> close in <span class="days-count">{initialDays}</span> {initialDays === 1 ? 'day' : 'days'}
    </span>
    <span class="deadline-arrow">→</span>
  </a>
)}

<script>
  // Update countdown in real-time (client-side)
  const deadlineEl = document.getElementById('order-deadline') as HTMLElement | null;
  
  if (deadlineEl) {
    const deadline = deadlineEl.dataset.deadline;
    if (deadline) {
      const deadlineDate = new Date(deadline + 'T23:59:59');
      
      function updateCountdown() {
        const now = new Date();
        const diffTime = deadlineDate.getTime() - now.getTime();
        const daysLeft = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        
        const daysEl = deadlineEl?.querySelector('.days-count');
        if (!deadlineEl || !daysEl) return;
        
        if (daysLeft <= 0) {
          deadlineEl.style.display = 'none';
          return;
        }
        
        // Update days count
        daysEl.textContent = daysLeft.toString();
        
        // Update "day" vs "days"
        const textEl = deadlineEl.querySelector('.deadline-text');
        if (textEl) {
          const label = textEl.querySelector('strong')?.textContent || 'Orders';
          textEl.innerHTML = `<strong>${label}</strong> close in <span class="days-count">${daysLeft}</span> ${daysLeft === 1 ? 'day' : 'days'}`;
        }
        
        // Update urgency class
        deadlineEl.classList.remove('normal', 'soon', 'urgent', 'expired');
        if (daysLeft <= 2) {
          deadlineEl.classList.add('urgent');
        } else if (daysLeft <= 5) {
          deadlineEl.classList.add('soon');
        } else {
          deadlineEl.classList.add('normal');
        }
      }
      
      // Update immediately and then every hour
      updateCountdown();
      setInterval(updateCountdown, 60 * 60 * 1000);
    }
  }
</script>

<style>
  .order-deadline {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    padding: var(--space-sm) var(--space-md);
    border-radius: 50px;
    text-decoration: none;
    font-size: 0.95rem;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    max-width: fit-content;
    margin: 0 auto var(--space-lg);
  }
  
  .order-deadline:hover {
    transform: translateY(-2px);
    text-decoration: none;
  }
  
  .deadline-icon {
    font-size: 1.2rem;
  }
  
  .deadline-text {
    color: inherit;
  }
  
  .deadline-text strong {
    font-weight: 600;
  }
  
  .days-count {
    font-weight: 700;
    font-size: 1.1em;
  }
  
  .deadline-arrow {
    opacity: 0.7;
    transition: transform 0.2s ease;
  }
  
  .order-deadline:hover .deadline-arrow {
    transform: translateX(3px);
  }
  
  /* Normal state - sage green */
  .order-deadline.normal {
    background: var(--sage-light);
    color: var(--sage-dark);
    border: 1px solid var(--sage);
  }
  
  .order-deadline.normal:hover {
    background: var(--sage);
    color: white;
    box-shadow: 0 4px 12px rgba(143, 163, 120, 0.3);
  }
  
  /* Soon state (≤5 days) - warm amber */
  .order-deadline.soon {
    background: #FEF3E2;
    color: #92400E;
    border: 1px solid #F59E0B;
  }
  
  .order-deadline.soon:hover {
    background: #F59E0B;
    color: white;
    box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
  }
  
  /* Urgent state (≤2 days) - warning red */
  .order-deadline.urgent {
    background: #FEE2E2;
    color: #991B1B;
    border: 1px solid #EF4444;
    animation: pulse-urgent 2s ease-in-out infinite;
  }
  
  .order-deadline.urgent:hover {
    background: #EF4444;
    color: white;
    box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
  }
  
  @keyframes pulse-urgent {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.02); }
  }
  
  /* Expired - hidden */
  .order-deadline.expired {
    display: none;
  }
  
  /* Mobile adjustments */
  @media (max-width: 480px) {
    .order-deadline {
      font-size: 0.85rem;
      padding: var(--space-xs) var(--space-sm);
    }
    
    .deadline-icon {
      font-size: 1rem;
    }
  }
</style>
