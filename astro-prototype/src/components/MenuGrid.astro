---
interface MenuItem {
  name: string;
  image: string;
  description: string;
  price: string;
  sold_out?: boolean;
  link?: string;
}

interface Props {
  items: MenuItem[];
  menuSlug: string;      // e.g., "valentines" - used to create unique IDs
  menuTitle: string;     // e.g., "Valentine's" - displayed in cart
  orderLink?: string;    // Fallback order link if item doesn't have one
}

const { items, menuSlug, menuTitle, orderLink } = Astro.props;

// Generate unique IDs for each item
function createItemId(itemName: string): string {
  const slug = itemName.toLowerCase().replace(/[^a-z0-9]+/g, '-');
  return `${menuSlug}-${slug}`;
}
---

<div class="menu-grid">
  {items.map((item) => {
    const itemLink = item.link || orderLink;
    const canOrder = !item.sold_out;
    const itemId = createItemId(item.name);
    
    return (
      <div class={`menu-item-card ${item.sold_out ? 'sold-out' : ''}`}>
        <div class="menu-item-image">
          <img 
            src={item.image} 
            alt={item.name} 
            loading="lazy" 
            decoding="async"
          />
          {item.sold_out && <span class="sold-out-badge">Sold Out</span>}
        </div>
        <div class="menu-item-content">
          <h3 class="menu-item-name">{item.name}</h3>
          <p class="menu-item-description">{item.description}</p>
          <p class="menu-item-price">{item.price}</p>
          {canOrder && (
            <button 
              class="add-to-inquiry-btn"
              data-item-id={itemId}
              data-item-name={item.name}
              data-item-price={item.price}
              data-item-image={item.image}
              data-item-menu={menuTitle}
              aria-label={`Add ${item.name} to inquiry`}
            >
              <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 5v14M5 12h14" stroke-linecap="round"/>
              </svg>
              <span class="btn-text">Add to Inquiry</span>
              <span class="btn-added" style="display: none;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M5 13l4 4L19 7" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                Added!
              </span>
            </button>
          )}
        </div>
      </div>
    );
  })}
</div>

<script>
  import { addItem, hasItem } from '../scripts/inquiry-store';

  document.addEventListener('DOMContentLoaded', () => {
    // Handle all "Add to Inquiry" buttons
    document.querySelectorAll('.add-to-inquiry-btn').forEach(button => {
      const btn = button as HTMLButtonElement;
      
      // Check if item is already in cart
      const itemId = btn.dataset.itemId;
      if (itemId && hasItem(itemId)) {
        showAddedState(btn);
      }
      
      btn.addEventListener('click', () => {
        const id = btn.dataset.itemId!;
        const name = btn.dataset.itemName!;
        const price = btn.dataset.itemPrice!;
        const image = btn.dataset.itemImage;
        const menu = btn.dataset.itemMenu!;
        
        // Add to cart
        addItem({ id, name, price, image, menu });
        
        // Visual feedback
        showAddedState(btn);
        
        // Reset after delay
        setTimeout(() => {
          resetButtonState(btn);
        }, 2000);
      });
    });
  });
  
  function showAddedState(btn: HTMLButtonElement) {
    btn.classList.add('added');
    const textEl = btn.querySelector('.btn-text') as HTMLElement;
    const addedEl = btn.querySelector('.btn-added') as HTMLElement;
    const iconEl = btn.querySelector('.btn-icon') as HTMLElement;
    
    if (textEl) textEl.style.display = 'none';
    if (iconEl) iconEl.style.display = 'none';
    if (addedEl) addedEl.style.display = 'flex';
  }
  
  function resetButtonState(btn: HTMLButtonElement) {
    btn.classList.remove('added');
    const textEl = btn.querySelector('.btn-text') as HTMLElement;
    const addedEl = btn.querySelector('.btn-added') as HTMLElement;
    const iconEl = btn.querySelector('.btn-icon') as HTMLElement;
    
    if (textEl) textEl.style.display = '';
    if (iconEl) iconEl.style.display = '';
    if (addedEl) addedEl.style.display = 'none';
  }
</script>

<style>
  .menu-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: var(--space-xl);
    max-width: 1200px;
    margin: 0 auto;
    padding: var(--space-lg);
  }
  
  .menu-item-card {
    background: var(--white);
    border-radius: 16px;
    overflow: hidden;
    box-shadow: var(--shadow-soft);
    transition: all var(--transition-smooth);
  }
  
  .menu-item-card:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-medium);
  }
  
  .menu-item-card.sold-out {
    opacity: 0.7;
  }
  
  .menu-item-card.sold-out:hover {
    transform: none;
  }
  
  .menu-item-image {
    position: relative;
    aspect-ratio: 4 / 3;
    overflow: hidden;
  }
  
  .menu-item-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform var(--transition-smooth);
  }
  
  .menu-item-card:not(.sold-out):hover .menu-item-image img {
    transform: scale(1.05);
  }
  
  .sold-out-badge {
    position: absolute;
    top: var(--space-md);
    right: var(--space-md);
    background: var(--terracotta);
    color: var(--white);
    padding: var(--space-xs) var(--space-md);
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }
  
  .menu-item-content {
    padding: var(--space-lg);
  }
  
  .menu-item-name {
    font-size: 1.375rem;
    margin-bottom: var(--space-sm);
    color: var(--charcoal);
  }
  
  .menu-item-description {
    color: var(--warm-gray);
    font-size: 0.9375rem;
    line-height: 1.6;
    margin-bottom: var(--space-md);
  }
  
  .menu-item-price {
    font-family: 'Caveat', cursive;
    font-size: 1.25rem;
    color: var(--sage);
    font-weight: 600;
    margin: 0;
  }
  
  .add-to-inquiry-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-sm);
    margin-top: var(--space-md);
    padding: var(--space-sm) var(--space-lg);
    background: linear-gradient(135deg, var(--sage) 0%, var(--sage-dark) 100%);
    color: var(--white);
    border: none;
    border-radius: 8px;
    font-weight: 500;
    font-size: 0.9375rem;
    font-family: var(--font-body);
    cursor: pointer;
    transition: all var(--transition-smooth);
    min-height: 44px;
    line-height: 1.5;
  }
  
  .add-to-inquiry-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(143, 163, 120, 0.4);
  }
  
  .add-to-inquiry-btn:active {
    transform: translateY(0);
  }
  
  .add-to-inquiry-btn.added {
    background: var(--sage-dark);
  }
  
  .btn-icon {
    width: 18px;
    height: 18px;
    flex-shrink: 0;
  }
  
  .btn-added {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
  }
  
  .btn-added svg {
    width: 18px;
    height: 18px;
  }
  
  @media (max-width: 600px) {
    .menu-grid {
      grid-template-columns: 1fr;
    }
  }
</style>
